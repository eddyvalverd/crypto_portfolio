services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: crypto_tracker_db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ./post_init.sql:/docker-entrypoint-initdb.d/02_post_init.sql:ro
    networks:
      - crypto_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin 4
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: postgres_pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@cryptotracker.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin-servers.json:/pgadmin4/servers.json:ro
    networks:
      - crypto_network
    depends_on:
      postgres:
        condition: service_healthy

  # CSV Export Service
  csv_exporter:
    image: postgres:16-alpine
    container_name: crypto_csv_exporter
    restart: "no"
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: postgres
    volumes:
      - ./exports:/exports
    networks:
      - crypto_network
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      sh -c "
      psql -c \"COPY (
        SELECT 
          portfolio_id, portfolio_name, portfolio_value, portfolio_pnl, 
          portfolio_pnl_percent, risk_per_trade_usd, crypto_symbol, crypto_rank, 
          crypto_name, current_price, atr_30, is_stablecoin, 
          has_pattern_to_break,
          trend_confirmation_percent,
          ((trend_confirmation_percent*0.01) * current_price) + current_price AS trend_confirmation_price,
          suggested_buy_price_golden_ratio,
          suggested_buy_price_glen,          
          volatility_ratio, stop_distance_atr, 
          suggested_stop_loss_price, suggested_stop_loss_price_golden_ratio, suggested_stop_loss_price_glen,
          min_stop_loss_price, max_stop_loss_price, 
          position_size_units, position_size_usd, position_weight_percent, 
          stop_loss_percent, holding_status, current_holding_units, 
          current_holding_value, btc_volatility_ratio, shortdays, mediumdays, longdays          
        FROM public.v_position_sizing_calculator 
        WHERE portfolio_id = 4
        ORDER BY volatility_ratio ASC
      ) TO STDOUT WITH CSV HEADER\" > /exports/position_sizing_$$\(date +%Y%m%d_%H%M%S\).csv &&
      echo 'CSV export completed successfully'
      "

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  crypto_network:
    driver: bridge