name: Database Setup and Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '*.sql'
      - '.github/workflows/database-setup.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '*.sql'
  workflow_dispatch:

env:
  POSTGRES_DB: crypto_tracker_test
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password_123
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5432

jobs:
  database-setup-and-test:
    name: Setup PostgreSQL and Run Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          TZ: America/Costa_Rica
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL to be ready
        run: |
          for i in {1..30}; do
            if pg_isready -h ${{ env.POSTGRES_HOST }} -p ${{ env.POSTGRES_PORT }} -U ${{ env.POSTGRES_USER }}; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Verify database connection
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "SELECT version();"

      - name: Run init.sql (Schema and Functions)
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Running init.sql..."
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f init.sql -v ON_ERROR_STOP=1
          echo "âœ“ init.sql completed successfully"

      - name: Run post_init.sql (Sample Data)
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Running post_init.sql..."
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f post_init.sql -v ON_ERROR_STOP=1
          echo "âœ“ post_init.sql completed successfully"

      - name: Validate database schema
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Validating database schema..."
          
          # Check all expected tables exist
          TABLES=$(psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -t -c "
            SELECT COUNT(*) FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_name IN ('portfolios', 'crypto_prices', 'transactions');
          ")
          
          if [ "$TABLES" -ne 3 ]; then
            echo "âŒ Expected 3 tables, found $TABLES"
            exit 1
          fi
          echo "âœ“ All required tables exist"

      - name: Validate stored procedures
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Validating stored procedures..."
          
          FUNCTIONS=$(psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -t -c "
            SELECT COUNT(*) FROM pg_proc 
            WHERE proname IN (
              'execute_trade', 'transfer_in', 'transfer_out', 
              'buy_with_fiat', 'sell_to_fiat', 'get_crypto_balance', 
              'get_portfolio_balances', 'get_trade_details'
            );
          ")
          
          if [ "$FUNCTIONS" -ne 8 ]; then
            echo "âŒ Expected 8 functions, found $FUNCTIONS"
            exit 1
          fi
          echo "âœ“ All stored procedures created successfully"



      - name: Validate sample data
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Validating sample data..."
          
          # Check portfolios
          PORTFOLIOS=$(psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -t -c "SELECT COUNT(*) FROM portfolios;")
          if [ "$PORTFOLIOS" -ne 4 ]; then
            echo "âŒ Expected 4 portfolios, found $PORTFOLIOS"
            exit 1
          fi
          echo "âœ“ Portfolios: $PORTFOLIOS"
          


      - name: Test balance calculations
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Testing balance calculations..."
          
          # Test Binance USDT balance
          BINANCE_USDT=$(psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -t -c "
            SELECT get_crypto_balance(
              (SELECT portfolio_id FROM portfolios WHERE name = 'Binance Testnet Portfolio'),
              'USDT'
            );
          " | xargs)
          
          echo "Binance USDT balance: $BINANCE_USDT"
          
          # Test portfolio balances function
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT * FROM get_portfolio_balances(
              (SELECT portfolio_id FROM portfolios WHERE name = 'Bybit Testnet Portfolio')
            );
          "
          
          echo "âœ“ Balance calculations working correctly"

      - name: Test views
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Testing views..."
          
          # Test holdings view
          echo "Testing v_holdings..."
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT portfolio_name, crypto_symbol, total_amount, total_cost 
            FROM v_holdings 
            LIMIT 5;
          "
          
          # Test portfolio summary
          echo "Testing v_portfolio_summary..."
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT * FROM v_portfolio_summary;
          "
          
          # Test transaction history
          echo "Testing v_transaction_history..."
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT transaction_id, portfolio_name, transaction_type, crypto_symbol, amount 
            FROM v_transaction_history 
            LIMIT 5;
          "
          
          echo "âœ“ All views working correctly"
          

      - name: Test timezone handling
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Testing timezone handling..."
          
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT 
              transaction_id,
              transaction_date,
              transaction_date AT TIME ZONE 'America/Costa_Rica' as cr_time
            FROM transactions 
            LIMIT 3;
          "
          
          echo "âœ“ Timezone handling verified"

      - name: Test trade execution function
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "Testing execute_trade function..."
          
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT * FROM execute_trade(
              p_portfolio_id := (SELECT portfolio_id FROM portfolios WHERE name = 'Binance Testnet Portfolio'),
              p_date := CURRENT_TIMESTAMP,
              p_crypto_buy := 'BTC',
              p_amount_buy := 0.001,
              p_crypto_sell := 'USDT',
              p_amount_sell := 100,
              p_fee := 0.1,
              p_fee_crypto := 'USDT',
              p_notes := 'Test trade from GitHub Actions'
            );
          "
          
          echo "âœ“ Trade execution function working"


      - name: Test check positions
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š POSITION SIZING CALCULATOR - 1% RISK / 1.5x ATR METHOD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -t -A -F"Â§" -c "
            SELECT 
              portfolio_name || 'Â§' ||
              crypto_symbol || 'Â§' ||
              crypto_name || 'Â§' ||
              TO_CHAR(current_price, 'FM999,999,990.00') || 'Â§' ||
              TO_CHAR(suggested_stop_loss_price, 'FM999,999,990.00') || 'Â§' ||
              TO_CHAR(stop_loss_percent, 'FM990.00') || 'Â§' ||
              TO_CHAR(position_size_units, 'FM999,990.00000000') || 'Â§' ||
              TO_CHAR(position_size_usd, 'FM999,999,990.00') || 'Â§' ||
              TO_CHAR(position_weight_percent, 'FM990.00') || 'Â§' ||
              holding_status || 'Â§' ||
              COALESCE(TO_CHAR(current_holding_value, 'FM999,999,990.00'), 'N/A')
            FROM v_position_sizing_calculator
            ORDER BY portfolio_id, position_size_usd DESC;
          " | while IFS='Â§' read -r portfolio crypto name price stop_loss stop_pct units usd_value weight status holding_value; do
            
            # Print portfolio header on first crypto
            if [ "$last_portfolio" != "$portfolio" ]; then
              if [ -n "$last_portfolio" ]; then
                echo ""
              fi
              echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              echo "â”‚ ðŸ¦ $portfolio"
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
              last_portfolio="$portfolio"
            fi
            
            # Determine holding emoji
            if [ "$status" = "HELD" ]; then
              hold_emoji="âœ…"
            else
              hold_emoji="âšª"
            fi
            
            echo ""
            echo "  $hold_emoji $crypto ($name)"
            echo "     ðŸ’° Current Price:    \$$price"
            echo "     ðŸ›‘ Stop Loss:        \$$stop_loss ($stop_pct%)"
            echo "     ðŸ“¦ Position Size:    $units units"
            echo "     ðŸ’µ USD Value:        \$$usd_value"
            echo "     ðŸ“Š Portfolio Weight: $weight%"
            if [ "$status" = "HELD" ]; then
              echo "     ðŸŽ¯ Current Holding:  \$$holding_value"
            fi
            
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Position sizing analysis complete"
          echo ""

      - name: Show portfolio summaries
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¼ PORTFOLIO SUMMARIES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -t -A -F"Â§" -c "
            SELECT 
              portfolio_name || 'Â§' ||
              TO_CHAR(current_value, 'FM999,999,990.00') || 'Â§' ||
              TO_CHAR(total_profit_loss, 'FM999,999,990.00') || 'Â§' ||
              TO_CHAR(total_profit_loss_percent, 'FM990.00') || 'Â§' ||
              TO_CHAR(current_value * 0.01, 'FM999,990.00') || 'Â§' ||
              unique_cryptos
            FROM v_portfolio_summary
            ORDER BY portfolio_id;
          " | while IFS='Â§' read -r name value pnl pnl_pct risk_amount cryptos; do
            
            # Determine profit emoji
            if (( $(echo "$pnl_pct > 0" | bc -l 2>/dev/null || echo 0) )); then
              pnl_emoji="ðŸ“ˆ"
            elif (( $(echo "$pnl_pct < 0" | bc -l 2>/dev/null || echo 0) )); then
              pnl_emoji="ðŸ“‰"
            else
              pnl_emoji="âž–"
            fi
            
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ðŸ¦ $name"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            echo "â”‚ ðŸ’° Total Value:        \$$value"
            echo "â”‚ $pnl_emoji P&L:               \$$pnl ($pnl_pct%)"
            echo "â”‚ ðŸŽ² Risk per Trade:     \$$risk_amount (1%)"
            echo "â”‚ ðŸª™ Unique Cryptos:     $cryptos"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            
          done
          
          echo "âœ“ Portfolio summaries complete"
          echo ""



      - name: Generate validation report
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          echo "## Database Validation Report" > validation_report.md
          echo "" >> validation_report.md
          echo "### Database Statistics" >> validation_report.md
          echo "" >> validation_report.md
          
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT 
              'Portfolios' as entity, COUNT(*) as count FROM portfolios
            UNION ALL
            SELECT 'Crypto Prices', COUNT(*) FROM crypto_prices
            UNION ALL
            SELECT 'Transactions', COUNT(*) FROM transactions;
          " >> validation_report.md
          
          echo "" >> validation_report.md
          echo "### Portfolio Summary" >> validation_report.md
          echo "" >> validation_report.md
          
          psql -h ${{ env.POSTGRES_HOST }} -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT * FROM v_portfolio_summary;
          " >> validation_report.md
          
          cat validation_report.md

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: database-validation-report
          path: validation_report.md
          retention-days: 30

      - name: Summary
        run: |
          echo "## âœ… Database Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All database scripts executed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Schema created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Functions and procedures deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Views created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Sample data loaded" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ All validations passed" >> $GITHUB_STEP_SUMMARY